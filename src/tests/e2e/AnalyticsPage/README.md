# E2E сценарии — Главная страница

## **Общая логика**

- Файл выбирается через кнопку **«Загрузить файл»** (`getByRole("button", name: "Загрузить файл")`) или перетаскивается в drop-зону (`data-testid="drop-zone"`).
- После выбора или дропа отображается имя файла внутри зоны.
- Если формат неверный (не CSV), сразу отображается ошибка в статусе (`data-testid="upload-status"`).
- Если формат валидный:

  - появляется кнопка **«Отправить»** (`getByRole("button", name: "Отправить")`)
  - при нажатии запускается загрузка на сервер
  - показывается loader (`data-testid="animated-loader"`) и статус **«идёт парсинг файла»**
  - кнопка **«Очистить»** (`getByTitle("Сбросить")`) скрыта во время обработки
  - по завершении появляется статус (**«готово!»** или ошибка), и кнопка **«Очистить»** снова видна
  - если данные валидные — рендерятся хайлайты (`data-testid="metrics-grid"`) с карточками (`data-testid="metrics-row"`)

- Все загруженные отчёты сохраняются в `localStorage` под ключом **`reports`**.
- Нажатие кнопки **«Очистить»** сбрасывает состояние UI до начального.

---

## **1. Загрузка валидного CSV через кнопку**

| #   | Шаг                     | Описание                                                                         |
| --- | ----------------------- | -------------------------------------------------------------------------------- |
| 1   | Открыть главную         | Перейти на `/`                                                                   |
| 2   | Нажать «Загрузить файл» | Открывается `filechooser`                                                        |
| 3   | Выбрать `valid.csv`     | Имя файла видно внутри `drop-zone`                                               |
| 4   | Проверить «Отправить»   | Кнопка активна                                                                   |
| 5   | Нажать «Отправить»      | Начинается загрузка                                                              |
| 6   | Проверить loader        | Появляется `animated-loader`, статус = «идёт парсинг файла»                      |
| 7   | Проверить «Очистить»    | Пока loader активен, кнопка сброса скрыта                                        |
| 8   | Дождаться результата    | Loader исчезает, статус = «готово!»                                              |
| 9   | Проверить хайлайты      | Видно `metrics-grid` с 8 карточками `metrics-row`                                |
| 10  | Проверить storage       | В `localStorage.reports` есть запись с `fileName: "valid.csv"` и `isValid: true` |
| 11  | Проверить «Очистить»    | Кнопка «X» снова видна                                                           |

---

## **2. Загрузка валидного CSV через Drag & Drop**

| #   | Шаг                    | Описание                                                    |
| --- | ---------------------- | ----------------------------------------------------------- |
| 1   | Открыть главную        | Перейти на `/`                                              |
| 2   | Перетащить `valid.csv` | Имя файла видно в `drop-zone`                               |
| 3   | Проверить «Отправить»  | Кнопка активна                                              |
| 4   | Нажать «Отправить»     | Начинается загрузка                                         |
| 5   | Проверить loader       | Появляется `animated-loader`, статус «идёт парсинг файла»   |
| 6   | Дождаться результата   | Статус «готово!», loader скрыт                              |
| 7   | Проверить хайлайты     | Есть `metrics-grid`                                         |
| 8   | Проверить storage      | В `localStorage.reports` есть `valid.csv` с `isValid: true` |
| 9   | Проверить «Очистить»   | Кнопка «X» снова видна                                      |

---

## **3. Загрузка PNG (не CSV) — мгновенная ошибка**

| #   | Шаг                                  | Описание                                               |
| --- | ------------------------------------ | ------------------------------------------------------ |
| 1   | Открыть главную                      | `/`                                                    |
| 2   | Загрузить или дропнуть `invalid.png` | Имя файла видно                                        |
| 3   | Проверить статус                     | В `upload-status` видна ошибка «Неверный формат файла» |
| 4   | Проверить «Отправить»                | Кнопка активна, но `pressSendButton` ничего не делает  |
| 5   | Проверить loader                     | `animated-loader` не появляется                        |
| 6   | Проверить хайлайты                   | `metrics-grid` не появляется                           |
| 7   | Проверить storage                    | В `localStorage.reports` нет `invalid.png`             |
| 8   | Проверить «Очистить»                 | Кнопка «X» видна                                       |

---

## **4. Пустой или битый CSV**

| #   | Шаг                     | Описание                                                       |
| --- | ----------------------- | -------------------------------------------------------------- |
| 1   | Открыть главную         | `/`                                                            |
| 2   | Загрузить `invalid.csv` | Имя видно                                                      |
| 3   | Нажать «Отправить»      | Начинается загрузка                                            |
| 4   | Проверить loader        | Есть `animated-loader` и статус «идёт парсинг файла»           |
| 5   | Дождаться результата    | Статус = «Некорректные данные в файле»                         |
| 6   | Проверить хайлайты      | `metrics-grid` не рендерится                                   |
| 7   | Проверить storage       | В `localStorage.reports` есть `invalid.csv` с `isValid: false` |
| 8   | Проверить «Очистить»    | Кнопка «X» снова видна                                         |

---

## **5. Очистка**

| #   | Шаг                  | Описание                                         |
| --- | -------------------- | ------------------------------------------------ |
| 1   | Загрузить файл       | Любой валидный или невалидный                    |
| 2   | Дождаться результата | «готово!» или ошибка                             |
| 3   | Нажать «X»           | Сброс состояния                                  |
| 4   | Проверить сброс      | Имя файла скрыто, статус пустой, хайлайты скрыты |

---

## **6. Ошибка сети**

| #   | Шаг                 | Описание                                                  |
| --- | ------------------- | --------------------------------------------------------- |
| 1   | Открыть главную     | Перейти на `/`.                                           |
| 2   | Загрузить valid.csv | Выбрать `valid.csv`.                                      |
| 3   | Перехватить запрос  | С помощью `route.abort` прервать `fetch` на `/aggregate`. |
| 4   | Нажать «Отправить»  | Запускается загрузка, но сеть прерывается.                |
| 5   | Проверить ошибку    | Отображается ошибка, статус содержит «fail».              |
| 6   | Проверить сброс     | В `localStorage` нет отчета.                              |

---

## ✅ Итоговые сценарии

| ID  | Название              | Тип        |
| --- | --------------------- | ---------- |
| 1   | Кнопка + valid.csv    | Позитивный |
| 2   | Drag & Drop valid.csv | Позитивный |
| 3   | PNG                   | Негативный |
| 4   | Битый CSV             | Негативный |
| 5   | Очистка               | Кросс      |
| 6   | Ошибка сети           | Негативный |
